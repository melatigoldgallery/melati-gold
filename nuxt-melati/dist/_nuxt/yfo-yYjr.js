import{m as T}from"#entry";const h=new Map,L=()=>{const c=(a,s)=>{if(!s)return a;const l=Object.keys(s).sort().map(f=>`${f}:${s[f]}`).join("|");return`${a}:${l}`},i=a=>a?Date.now()-a.timestamp<a.expiresIn:!1,b=a=>{const s=h.get(a);return s&&i(s)?s.data:(s&&h.delete(a),null)},P=a=>{try{const s=localStorage.getItem(a);if(!s)return null;const l=JSON.parse(s);return i(l)?l.data:(localStorage.removeItem(a),null)}catch(s){return console.error("Cache read error:",s),null}},m=(a,s,l)=>{h.set(a,{data:s,timestamp:Date.now(),expiresIn:l})},S=(a,s,l)=>{try{const f={data:s,timestamp:Date.now(),expiresIn:l};localStorage.setItem(a,JSON.stringify(f))}catch(f){console.error("Cache write error:",f)}},p=(a,s={})=>{const{useMemoryCache:l=!0,useLocalStorage:f=!0}=s;if(l){const y=b(a);if(y!==null)return y}if(f){const y=P(a);if(y!==null)return l&&m(a,y,s.ttl||3e5),y}return null},w=(a,s,l={})=>{const{ttl:f=3e5,useMemoryCache:y=!0,useLocalStorage:C=!0}=l;y&&m(a,s,f),C&&S(a,s,f)};return{generateKey:c,get:p,set:w,remove:a=>{h.delete(a),localStorage.removeItem(a)},clearPrefix:a=>{for(const s of h.keys())s.startsWith(a)&&h.delete(s);Object.keys(localStorage).forEach(l=>{l.startsWith(a)&&localStorage.removeItem(l)})},clearAll:()=>{h.clear(),localStorage.clear()},getStats:()=>{const a=h.size,s=Object.keys(localStorage).length;return{memory:{entries:a,keys:Array.from(h.keys())},localStorage:{entries:s}}},fetchWithCache:async(a,s,l={})=>{const f=p(a,l);if(f!==null)return f;const y=await s();return w(a,y,l),y}}},z=()=>{const{$supabase:n}=T(),c=L();if(!n)throw new Error("Supabase client is not available");const i=r=>r instanceof Error?r.message:String(r);return{getCategories:async(r=!0)=>{try{const e=c.generateKey("catalog_categories");if(r)return await c.fetchWithCache(e,async()=>{const{data:o,error:g}=await n.from("catalog_categories").select("*").order("display_order",{ascending:!0});if(g)throw g;return{success:!0,data:o||[]}},{ttl:600*1e3});const{data:t,error:u}=await n.from("catalog_categories").select("*").order("display_order",{ascending:!0});if(u)throw u;return{success:!0,data:t||[]}}catch(e){return console.error("[useCatalogManager] Error fetching categories:",e),{success:!1,error:i(e),data:[]}}},createCategory:async r=>{try{const{data:e,error:t}=await n.from("catalog_categories").insert([r]).select().single();if(t)throw t;return c.clearPrefix("catalog_categories"),{success:!0,data:e}}catch(e){return console.error("Error creating category:",e),{success:!1,error:i(e)}}},updateCategory:async(r,e)=>{try{const{...t}=e,{data:u,error:o}=await n.from("catalog_categories").update(t).eq("id",r).select().single();if(o)throw o;return c.clearPrefix("catalog_categories"),{success:!0,data:u}}catch(t){return console.error("Error updating category:",t),{success:!1,error:i(t)}}},deleteCategory:async r=>{try{const{error:e}=await n.from("catalog_categories").delete().eq("id",r);if(e)throw e;return c.clearPrefix("catalog_categories"),{success:!0}}catch(e){return console.error("Error deleting category:",e),{success:!1,error:i(e)}}},getSubcategories:async(r,e=!0)=>{try{const t=c.generateKey("catalog_subcategories",{categoryId:r});if(e)return await c.fetchWithCache(t,async()=>await u(),{ttl:600*1e3});return await u();async function u(){let o=n.from("catalog_subcategories").select(`
            *,
            category:catalog_categories(id, name, slug)
          `).order("display_order",{ascending:!0});r&&(o=o.eq("category_id",r));const{data:g,error:d}=await o;if(d)throw d;return{success:!0,data:g||[]}}}catch(t){return console.error("Error fetching subcategories:",t),{success:!1,error:i(t),data:[]}}},createSubcategory:async r=>{try{const{data:e,error:t}=await n.from("catalog_subcategories").insert([r]).select().single();if(t)throw t;return c.clearPrefix("catalog_subcategories"),{success:!0,data:e}}catch(e){return console.error("Error creating subcategory:",e),{success:!1,error:i(e)}}},updateSubcategory:async(r,e)=>{try{const{category:t,...u}=e,{data:o,error:g}=await n.from("catalog_subcategories").update(u).eq("id",r).select().single();if(g)throw g;return c.clearPrefix("catalog_subcategories"),console.log("[useCatalogManager] Cache invalidated after updating subcategory"),{success:!0,data:o}}catch(t){return console.error("Error updating subcategory:",t),{success:!1,error:i(t)}}},deleteSubcategory:async r=>{try{const{error:e}=await n.from("catalog_subcategories").delete().eq("id",r);if(e)throw e;return c.clearPrefix("catalog_subcategories"),{success:!0}}catch(e){return console.error("Error deleting subcategory:",e),{success:!1,error:i(e)}}},getProducts:async r=>{try{const e=r?.page||1,t=r?.limit||50,u=r?.useCache!==!1,o=r?.selectAll||!1,g=(e-1)*t,d=g+t-1,W=c.generateKey("catalog_products",{categoryId:r?.categoryId,subcategoryId:r?.subcategoryId,isFeatured:r?.isFeatured,isBestSeller:r?.isBestSeller,page:e,limit:t,selectAll:o});if(u)return await c.fetchWithCache(W,async()=>await x(),{ttl:300*1e3});return await x();async function x(){const M=o?`
            *,
            category:catalog_categories(id, name, slug),
            subcategory:catalog_subcategories(id, name, slug)
          `:`
            id,
            title,
            thumbnail_image,
            price,
            price_display,
            karat,
            weight,
            is_featured,
            is_best_seller,
            is_active,
            stock_status,
            display_order,
            category_id,
            subcategory_id,
            category:catalog_categories(id, name, slug),
            subcategory:catalog_subcategories(id, name, slug)
          `;let _=n.from("catalog_products").select(M,{count:"exact"}).eq("is_active",!0).order("display_order",{ascending:!0}).range(g,d);r&&(r.categoryId&&(_=_.eq("category_id",r.categoryId)),r.subcategoryId&&(_=_.eq("subcategory_id",r.subcategoryId)),r.isFeatured!==void 0&&(_=_.eq("is_featured",r.isFeatured)),r.isBestSeller!==void 0&&(_=_.eq("is_best_seller",r.isBestSeller)));const{data:K,error:E,count:v}=await _;if(E)throw E;return{success:!0,data:K||[],pagination:{page:e,limit:t,total:v||0,totalPages:Math.ceil((v||0)/t),hasMore:(v||0)>d+1}}}}catch(e){return console.error("Error fetching products:",e),{success:!1,error:i(e),data:[],pagination:{page:1,limit:50,total:0,totalPages:0,hasMore:!1}}}},getProductById:async r=>{try{const{data:e,error:t}=await n.from("catalog_products").select(`
          *,
          category:catalog_categories(id, name, slug),
          subcategory:catalog_subcategories(id, name, slug)
        `).eq("id",r).single();if(t)throw t;return{success:!0,data:e}}catch(e){return console.error("Error fetching product:",e),{success:!1,error:i(e)}}},createProduct:async r=>{try{const{data:e,error:t}=await n.from("catalog_products").insert([r]).select().single();if(t)throw t;return c.clearPrefix("catalog_products"),c.clearPrefix("v_featured_products"),c.clearPrefix("v_best_sellers"),{success:!0,data:e}}catch(e){return console.error("Error creating product:",e),{success:!1,error:i(e)}}},updateProduct:async(r,e)=>{try{const{category:t,subcategory:u,...o}=e,{data:g,error:d}=await n.from("catalog_products").update(o).eq("id",r).select().single();if(d)throw d;return c.clearPrefix("catalog_products"),c.clearPrefix("v_featured_products"),c.clearPrefix("v_best_sellers"),{success:!0,data:g}}catch(t){return console.error("Error updating product:",t),{success:!1,error:i(t)}}},deleteProduct:async r=>{try{const{error:e}=await n.from("catalog_products").delete().eq("id",r);if(e)throw e;return c.clearPrefix("catalog_products"),c.clearPrefix("v_featured_products"),c.clearPrefix("v_best_sellers"),{success:!0}}catch(e){return console.error("Error deleting product:",e),{success:!1,error:i(e)}}},toggleProductFeatured:async r=>{try{const{data:e,error:t}=await n.rpc("toggle_featured",{p_product_id:r});if(t)throw t;return c.clearPrefix("catalog_products"),c.clearPrefix("v_featured_products"),{success:!0}}catch(e){return console.error("Error toggling featured:",e),{success:!1,error:i(e)}}},toggleProductBestSeller:async r=>{try{const{data:e,error:t}=await n.rpc("toggle_best_seller",{p_product_id:r});if(t)throw t;return c.clearPrefix("catalog_products"),c.clearPrefix("v_best_sellers"),{success:!0}}catch(e){return console.error("Error toggling best seller:",e),{success:!1,error:i(e)}}},getCustomServices:async(r=!0)=>{try{const e=c.generateKey("custom_services");if(r)return await c.fetchWithCache(e,async()=>await t(),{ttl:600*1e3});return await t();async function t(){const{data:u,error:o}=await n.from("custom_services").select("*").eq("is_active",!0).order("display_order",{ascending:!0});if(o)throw o;return{success:!0,data:u||[]}}}catch(e){return console.error("Error fetching custom services:",e),{success:!1,error:i(e),data:[]}}},createCustomService:async r=>{try{const{data:e,error:t}=await n.from("custom_services").insert([r]).select().single();if(t)throw t;return c.clearPrefix("custom_services"),{success:!0,data:e}}catch(e){return console.error("Error creating service:",e),{success:!1,error:i(e)}}},updateCustomService:async(r,e)=>{try{const{...t}=e,{data:u,error:o}=await n.from("custom_services").update(t).eq("id",r).select().single();if(o)throw o;return c.clearPrefix("custom_services"),{success:!0,data:u}}catch(t){return console.error("Error updating service:",t),{success:!1,error:i(t)}}},deleteCustomService:async r=>{try{const{error:e}=await n.from("custom_services").delete().eq("id",r);if(e)throw e;return c.clearPrefix("custom_services"),console.log("[useCatalogManager] Cache invalidated after deleting custom service"),{success:!0}}catch(e){return console.error("Error deleting service:",e),{success:!1,error:i(e)}}},getServiceWithProducts:async r=>{try{const{data:e,error:t}=await n.from("custom_services").select("*").eq("id",r).single();if(t)throw t;if(!e)return{success:!1,error:"Service not found",data:null};let u=[];if(e.example_products&&e.example_products.length>0){const{data:g,error:d}=await n.from("catalog_products").select("id, title, name, description, thumbnail_image, price, price_display, stock_status, category_id, subcategory_id, weight, karat").in("id",e.example_products).eq("is_active",!0);d?console.error("[getServiceWithProducts] Error fetching service products:",d):u=g||[]}else console.log("[getServiceWithProducts] No example_products to fetch");return{success:!0,data:{...e,products:u}}}catch(e){return console.error("[getServiceWithProducts] Error:",e),{success:!1,error:i(e),data:null}}},getBestSellers:async(r,e=!0)=>{try{const t=c.generateKey("v_best_sellers",{limit:r});if(e)return await c.fetchWithCache(t,async()=>await u(),{ttl:300*1e3});return await u();async function u(){let o=n.from("v_best_sellers").select("*");r&&(o=o.limit(r));const{data:g,error:d}=await o;if(d)throw d;return{success:!0,data:g||[]}}}catch(t){return console.error("Error fetching best sellers:",t),{success:!1,error:i(t),data:[]}}},getFeaturedProducts:async(r,e=!0)=>{try{const t=c.generateKey("v_featured_products",{limit:r});if(e)return await c.fetchWithCache(t,async()=>await u(),{ttl:300*1e3});return await u();async function u(){let o=n.from("v_featured_products").select("*");r&&(o=o.limit(r));const{data:g,error:d}=await o;if(d)throw d;return{success:!0,data:g||[]}}}catch(t){return console.error("Error fetching featured products:",t),{success:!1,error:i(t),data:[]}}},bulkUpdateDisplayOrder:async(r,e)=>{try{const t=e.map(u=>n.from(r).update({display_order:u.display_order}).eq("id",u.id));return await Promise.all(t),r==="catalog_categories"?c.clearPrefix("catalog_categories"):r==="catalog_subcategories"?c.clearPrefix("catalog_subcategories"):r==="catalog_products"?(c.clearPrefix("catalog_products"),c.clearPrefix("v_featured_products"),c.clearPrefix("v_best_sellers")):r==="custom_services"&&c.clearPrefix("custom_services"),{success:!0}}catch(t){return console.error("Error bulk updating display order:",t),{success:!1,error:i(t)}}}}};export{z as u};
